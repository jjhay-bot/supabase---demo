# Supabase: Tables, Policies, and Helpers

How to add/adjust tables with RLS and where our reusable Supabase helpers live.

## Where things live
- Migrations: `supabase/migrations/*.sql`
- Supabase config: `supabase/config.toml`
- App client + helpers: `src/lib/supabaseClient.ts`

## Creating or updating tables
1) Make the change in Supabase:
   - Easiest: Supabase Studio → Table Editor → Create table / Add column.
   - Or run SQL in the SQL editor (example below).
2) Turn on RLS (see next section) and add policies before exposing to clients.
3) Capture the change as a migration so the repo stays in sync:
   ```bash
   supabase db diff --project-ref <project-ref> -f <short-name>.sql
   ```
   This pulls the diff from the remote project into `supabase/migrations`. Commit it.

### Example: create a `buckets` table via SQL
```sql
create table if not exists public.buckets (
  id bigint generated by default as identity primary key,
  uid text unique,                       -- external-friendly id/slug
  related_user_id bigint not null,       -- owner
  title text not null,
  description text,
  created_by bigint not null,
  created_at timestamptz not null default now(),
  updated_at timestamptz default now()
);
```

## Enabling RLS and adding policies
Always enable row level security and write least-privilege policies that match your ownership model.

```sql
alter table public.buckets enable row level security;

-- Owners can see their own buckets
create policy "select own buckets" on public.buckets
  for select
  to authenticated
  using (related_user_id = auth.uid());

-- Owners can insert/update/delete only their buckets
create policy "insert own buckets" on public.buckets
  for insert
  to authenticated
  with check (related_user_id = auth.uid());

create policy "update own buckets" on public.buckets
  for update
  to authenticated
  using (related_user_id = auth.uid());

create policy "delete own buckets" on public.buckets
  for delete
  to authenticated
  using (related_user_id = auth.uid());
```

Patterns:
- Use `auth.uid()` for matching against owner columns.
- Add role-specific policies (e.g., `service_role` for admin jobs) only when needed.
- Test policies with the Supabase policy simulator or `supabase-js` queries using anon vs. service keys.

## Helpers available in the app
All Supabase client code is centralized in `src/lib/supabaseClient.ts`:
- `supabase`: base client configured from `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY`.
- Auth: `getCurrentSession`, `signInWithOtp`, `signOut`.
- Posts CRUD helpers: `createPost`, `listPosts`, `getPostById`, `updatePost`, `deletePost`, `listPublicPosts`, plus `DEFAULT_PAGE_SIZE`.

When adding new tables, mirror this pattern:
- Add typed helpers per table in `supabaseClient.ts` or a sibling module.
- Keep return shapes `{ data, error, count? }` consistent with existing helpers.
- Let RLS enforce ownership; keep client/server code thin.

## Quick checklist for schema changes
- [ ] Create/alter table (Studio or SQL).
- [ ] Enable RLS.
- [ ] Add `select/insert/update/delete` policies that match ownership rules.
- [ ] Run minimal data constraints (NOT NULL, foreign keys, defaults).
- [ ] Capture migration with `supabase db diff ...` and commit.
